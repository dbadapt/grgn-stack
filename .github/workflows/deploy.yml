name: Deploy

on:
  # Disabled auto-deploy until secrets are configured
  # push:
  #   branches:
  #     - master # Production (GitHub default)
  #     - main # Production
  #     - staging # Staging
  #     - develop # Development
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      docker-compose-file: ${{ steps.set-env.outputs.docker-compose-file }}

    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            ENV="staging"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="development"
          else
            ENV="development"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          if [ "$ENV" == "production" ]; then
            echo "docker-compose-file=docker-compose.yml -f docker-compose.prod.yml" >> $GITHUB_OUTPUT
          elif [ "$ENV" == "staging" ]; then
            echo "docker-compose-file=docker-compose.yml -f docker-compose.staging.yml" >> $GITHUB_OUTPUT
          else
            echo "docker-compose-file=docker-compose.yml -f docker-compose.dev.yml" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    name: Build & Deploy to ${{ needs.determine-environment.outputs.environment }}
    needs: determine-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and tag images
        run: |
          ENV=${{ needs.determine-environment.outputs.environment }}
          TAG="${{ github.sha }}"

          # Build backend
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-backend:${TAG} \
                       -t ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-backend:${ENV} \
                       ./backend

          # Build frontend
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-web:${TAG} \
                       -t ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-web:${ENV} \
                       ./web

      - name: Push images
        run: |
          ENV=${{ needs.determine-environment.outputs.environment }}
          TAG="${{ github.sha }}"

          docker push ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-backend:${TAG}
          docker push ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-backend:${ENV}
          docker push ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-web:${TAG}
          docker push ${{ secrets.DOCKER_REGISTRY }}/grgn-stack-web:${ENV}

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/grgn-stack
            git pull origin ${{ github.ref_name }}
            docker-compose ${{ needs.determine-environment.outputs.docker-compose-file }} pull
            docker-compose ${{ needs.determine-environment.outputs.docker-compose-file }} up -d
            docker system prune -f

      - name: Verify deployment
        run: |
          echo "Deployment to ${{ needs.determine-environment.outputs.environment }} completed"
          echo "Environment URL: ${{ vars.APP_URL }}"

  notify:
    name: Notify Deployment Status
    needs: [determine-environment, build-and-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Success
        if: needs.build-and-deploy.result == 'success'
        run: |
          echo "✅ Deployment to ${{ needs.determine-environment.outputs.environment }} successful!"

      - name: Deployment Failure
        if: needs.build-and-deploy.result == 'failure'
        run: |
          echo "❌ Deployment to ${{ needs.determine-environment.outputs.environment }} failed!"
          exit 1
